<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Shiba - Live Map</title>
  <link rel="stylesheet" href="../theme.css">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #sidebar {
      width: 250px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: var(--spacing-lg);
      box-sizing: border-box;
      overflow-y: auto;
    }
    #sidebar h3 {
      margin-top: 0;
      margin-bottom: var(--spacing-md);
      font-size: 18px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: var(--spacing-sm);
    }
    #sidebar section {
      margin-bottom: 25px;
    }
    .map-button {
      display: block;
      width: 100%;
      padding: 3px 7px;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      text-align: left;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .map-button:hover {
      background: var(--bg-hover);
    }
    .map-button.active {
      background: var(--accent-primary);
    }
    .player-item {
      padding: 8px 10px;
      margin-bottom: 5px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .player-item:hover {
      background: var(--bg-hover);
    }
    .player-avatar {
      width: 24px;
      height: 24px;
      background: var(--text-muted);
      border-radius: 2px;
    }
    .player-name {
      flex: 1;
    }
    .player-world {
      font-size: 11px;
      color: var(--text-muted);
    }
    #player-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: var(--spacing-sm);
    }
    #iframe-container {
      flex: 1;
      position: relative;
    }
    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
    #loading {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: var(--spacing-sm);
    }
    .back-link {
      display: inline-block;
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 13px;
      transition: background 0.2s ease;
    }
    .back-link:hover {
      background: var(--bg-hover);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <a href="../" class="back-link">‚Üê Back to Home</a>
      
      <section>
        <h3>Maps</h3>
        <div id="map-buttons"></div>
        <div id="loading">Loading maps...</div>
      </section>
      
      <section>
        <h3>Players</h3>
        <div id="player-count">Loading...</div>
        <div id="players-list"></div>
      </section>
    </div>
    <div id="iframe-container">
      <iframe src="dynmap/" title="Minecraft Dynmap"></iframe>
    </div>
  </div>
  <div style="position: fixed; left: 12px; bottom: 12px;">
    <div class="site-contrib">
      <a href="https://github.com/anton2026gamca/super-shiba-minecraft-server-website/blob/main/map/index.html" target="_blank" rel="noopener">
        <svg aria-hidden="true" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.58.82-2.14-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.14 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
        </svg>
        Contribute on GitHub
      </a>
    </div>
  </div>
  <script>
    const WORLDS_CONFIG = [
      {
        worldName: 'world',
        displayName: 'Overworld',
        defaultZoom: 0,
        maps: [
          { mapName: 'flat', displayName: 'Flat' },
          { mapName: 'surface', displayName: '3D' }
        ]
      },
      {
        worldName: 'DIM-1',
        displayName: 'Nether',
        defaultZoom: 2,
        maps: [
          { mapName: 'flat', displayName: 'Flat' },
          { mapName: 'nether', displayName: '3D' }
        ]
      },
      {
        worldName: 'DIM1',
        displayName: 'The End',
        defaultZoom: 2,
        maps: [
          { mapName: 'flat', displayName: 'Flat' },
          { mapName: 'the_end', displayName: '3D' }
        ]
      }
    ];
    
    const iframe = document.querySelector('iframe');
    const mapButtonsContainer = document.getElementById('map-buttons');
    const loadingText = document.getElementById('loading');
    const playersListContainer = document.getElementById('players-list');
    const playerCountElement = document.getElementById('player-count');
    let currentMapIndex = 0;
    let updateInterval = null;
    let worldPositions = {};
    let currentWorldName = null;
    let currentMapName = null;
    
    iframe.addEventListener('load', function() {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        const style = iframeDoc.createElement('style');
        style.textContent = `
          .sidebar,
          .chat,
          .chatbox,
          .chatinput,
          .players,
          .playerlist,
          .compass,
          .coord-control,
          .coordbox,
          .clock,
          .timeofday,
          .weather,
          .link-control,
          .dynmap-playerlist,
          .dynmap-chat,
          .largeclock,
          .dynmap .sidebar,
          .dynmap .compass,
          .digitalsignature,
          div.coord-control,
          div.clock,
          div.link-control,
          div.compass,
          .leaflet-control-layers,
          .leaflet-control-zoom,
          .leaflet-bar,
          a.leaflet-control-zoom-in,
          a.leaflet-control-zoom-out,
          .leaflet-control,
          .dynmap-link-control {
            display: none !important;
          }
        `;

        iframeDoc.head.appendChild(style);
        
        setTimeout(() => {
          updateCurrentPosition();
        }, 1000);
      } catch (e) {
        console.error('Cannot access iframe content (likely cross-origin):', e);
      }
      
      updatePlayers();
      updateInterval = setInterval(updatePlayers, 1000);
      
      setInterval(updateCurrentPosition, 1000);
    });
    
    function displayMapsFromConfig() {
      mapButtonsContainer.innerHTML = '';
      loadingText.style.display = 'none';
      
      let isFirst = true;
      
      WORLDS_CONFIG.forEach((world) => {
        const worldHeader = document.createElement('div');
        worldHeader.style.cssText = 'color: var(--text-muted); font-size: 11px; text-transform: uppercase; margin-top: 15px; margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px;';
        worldHeader.textContent = world.displayName;
        mapButtonsContainer.appendChild(worldHeader);
        
        world.maps.forEach((map) => {
          const button = document.createElement('button');
          button.className = 'map-button';
          button.textContent = map.displayName;
          button.dataset.worldName = world.worldName;
          button.dataset.mapName = map.mapName;
          button.dataset.defaultZoom = world.defaultZoom;
          
          if (isFirst) {
            button.classList.add('active');
            currentWorldName = world.worldName;
            currentMapName = map.mapName;
            isFirst = false;
          }
          
          button.addEventListener('click', () => {
            switchToMap(world.worldName, map.mapName, world.defaultZoom);
            document.querySelectorAll('.map-button').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
          });
          
          mapButtonsContainer.appendChild(button);
        });
      });
    }
    
    function switchToMap(worldName, mapName, defaultZoom) {
      if (currentWorldName) {
        updateCurrentPosition();
      }
      
      let position = worldPositions[worldName] || { x: 0, z: 0, zoom: defaultZoom };
      
      const link = `dynmap/?worldname=${encodeURIComponent(worldName)}&mapname=${encodeURIComponent(mapName)}&zoom=${position.zoom}&x=${position.x}&z=${position.z}`;
      
      currentWorldName = worldName;
      currentMapName = mapName;
      
      iframe.src = link;
    }
    
    function updateCurrentPosition() {
      if (!currentWorldName) return;
      
      try {
        const iframeWindow = iframe.contentWindow;
        
        if (iframeWindow.dynmap && iframeWindow.dynmap.map) {
          const map = iframeWindow.dynmap.map;
          const center = map.getCenter();
          const zoom = map.getZoom();
          
          if (center && iframeWindow.dynmap.getProjection) {
            const projection = iframeWindow.dynmap.getProjection();
            if (projection && projection.fromLatLngToLocation) {
              const location = projection.fromLatLngToLocation(center, 64);
              worldPositions[currentWorldName] = {
                x: Math.round(location.x),
                z: Math.round(location.z),
                zoom: zoom || 0
              };
            }
          }
        } else {
          const iframeUrl = iframe.contentWindow.location.href;
          const url = new URL(iframeUrl);
          const x = url.searchParams.get('x');
          const z = url.searchParams.get('z');
          const zoom = url.searchParams.get('zoom');
          
          if (x !== null && z !== null) {
            if (!worldPositions[currentWorldName]) {
              worldPositions[currentWorldName] = { x: 0, z: 0, zoom: 0 };
            }
            worldPositions[currentWorldName].x = parseFloat(x);
            worldPositions[currentWorldName].z = parseFloat(z);
            if (zoom !== null) {
              worldPositions[currentWorldName].zoom = parseInt(zoom);
            }
          }
        }
      } catch (e) {
        console.debug('Could not update position:', e.message);
      }
    }
    
    displayMapsFromConfig();
    
    function updatePlayers() {
      fetch('dynmap/up/world/world/' + Date.now())
        .then(response => response.json())
        .then(data => {
          displayPlayers(data.players || []);
        })
        .catch(err => {
          fetch('dynmap/up/configuration')
            .then(response => response.json())
            .then(config => {
              if (config.players) {
                displayPlayers(config.players);
              }
            })
            .catch(e => {
              console.error('Error fetching players:', e);
              playerCountElement.textContent = 'Unable to fetch players';
            });
        });
    }
    
    function displayPlayers(players) {
      playerCountElement.textContent = `${players.length} player${players.length !== 1 ? 's' : ''} online`;
      playersListContainer.innerHTML = '';
      
      if (players.length === 0) {
        return;
      }
      
      players.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';
        
        const avatar = document.createElement('img');
        avatar.className = 'player-avatar';
        const playerName = player.name || player.account;
        avatar.src = `https://mc-heads.net/avatar/${playerName}/24`;
        avatar.alt = playerName;
        avatar.onerror = function() {
                  const fallback = document.createElement('div');
          fallback.className = 'player-avatar';
          fallback.style.background = '#' + Math.floor(Math.abs(Math.sin(playerName.charCodeAt(0)) * 16777215)).toString(16);
          fallback.style.display = 'flex';
          fallback.style.alignItems = 'center';
          fallback.style.justifyContent = 'center';
          fallback.style.color = 'white';
          fallback.style.fontWeight = 'bold';
          fallback.textContent = playerName.charAt(0).toUpperCase();
          this.replaceWith(fallback);
        };
        
        const nameContainer = document.createElement('div');
        nameContainer.style.flex = '1';
        
        const name = document.createElement('div');
        name.className = 'player-name';
        name.textContent = playerName;
        
        const world = document.createElement('div');
        world.className = 'player-world';
        world.textContent = player.world || '';
        
        nameContainer.appendChild(name);
        if (player.world) {
          nameContainer.appendChild(world);
        }
        
        playerItem.appendChild(avatar);
        playerItem.appendChild(nameContainer);
        
        playerItem.addEventListener('click', () => {
          centerOnPlayer(player);
        });
        
        playersListContainer.appendChild(playerItem);
      });
    }
    
    function centerOnPlayer(player) {
      try {
        const iframeWindow = iframe.contentWindow;
        
        if (iframeWindow.dynmap && iframeWindow.dynmap.panToPlayer) {
          iframeWindow.dynmap.panToPlayer(player.name || player.account);
        } else if (player.x !== undefined && player.z !== undefined) {
          if (iframeWindow.dynmap && iframeWindow.dynmap.map) {
            const map = iframeWindow.dynmap.map;
            if (map.panTo) {
              const projection = iframeWindow.dynmap.getProjection();
              if (projection) {
                const latlng = projection.fromLocationToLatLng({ x: player.x, y: player.y || 64, z: player.z });
                map.panTo(latlng);
              }
            }
          }
        }
      } catch (e) {
        console.error('Error centering on player:', e);
      }
    }
    
    window.addEventListener('beforeunload', () => {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    });
  </script>
</body>
</html>
